<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Net::SSH::Transport::PacketStream - net-ssh 6.0.0.beta1</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../";
  var index_rel_prefix = "../../../";
</script>

<script src="../../../js/jquery.js"></script>
<script src="../../../js/darkfish.js"></script>

<link href="../../../css/fonts.css" rel="stylesheet">
<link href="../../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="../BufferedIo.html">Net::SSH::BufferedIo</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-extended">::extended</a>
    
    <li ><a href="#method-i-available_for_read-3F">#available_for_read?</a>
    
    <li ><a href="#method-i-cleanup">#cleanup</a>
    
    <li ><a href="#method-i-client_name">#client_name</a>
    
    <li ><a href="#method-i-enqueue_packet">#enqueue_packet</a>
    
    <li ><a href="#method-i-if_needs_rekey-3F">#if_needs_rekey?</a>
    
    <li ><a href="#method-i-initialize_ssh">#initialize_ssh</a>
    
    <li ><a href="#method-i-next_packet">#next_packet</a>
    
    <li ><a href="#method-i-peer_ip">#peer_ip</a>
    
    <li ><a href="#method-i-poll_next_packet">#poll_next_packet</a>
    
    <li ><a href="#method-i-send_packet">#send_packet</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Net::SSH::Transport::PacketStream">
  <h1 id="module-Net::SSH::Transport::PacketStream" class="module">
    module Net::SSH::Transport::PacketStream
  </h1>

  <section class="description">
    
<p>A module that builds additional functionality onto the <a
href="../BufferedIo.html">Net::SSH::BufferedIo</a> module. It adds <a
href="../../SSH.html">SSH</a> encryption, compression, and packet
validation, as per the SSH2 protocol. It also adds an abstraction for
polling packets, to allow for both blocking and non-blocking reads.</p>

  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="PROXY_COMMAND_HOST_IP">PROXY_COMMAND_HOST_IP
        
        <dd>
        
      
      </dl>
    </section>
    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-client" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">client</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>The client state object, which encapsulates the algorithms used to build
packets to send to the server.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-hints" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">hints</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>The map of “hints” that can be used to modify the behavior of the packet
stream. For instance, when authentication succeeds, an “authenticated” hint
is set, which is used to determine whether or not to compress the data when
using the “delayed” compression algorithm.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-server" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">server</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>The server state object, which encapsulates the algorithms used to
interpret packets coming from the server.</p>
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-extended" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">extended</span><span
            class="method-args">(object)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="extended-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 22</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">extended</span>(<span class="ruby-identifier">object</span>)
  <span class="ruby-identifier">object</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-value">:initialize_ssh</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-available_for_read-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">available_for_read?</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns true if the IO is available for reading, and false otherwise.</p>
          
          

          
          <div class="method-source-code" id="available_for_read-3F-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 75</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">available_for_read?</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">select</span>([<span class="ruby-keyword">self</span>], <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-value">0</span>)
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">any?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cleanup" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cleanup</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Performs any pending cleanup necessary on the IO and its associated state
objects. (See <a
href="State.html#method-i-cleanup">Net::SSH::Transport::State#cleanup</a>).</p>
          
          

          
          <div class="method-source-code" id="cleanup-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 186</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cleanup</span>
  <span class="ruby-identifier">client</span>.<span class="ruby-identifier">cleanup</span>
  <span class="ruby-identifier">server</span>.<span class="ruby-identifier">cleanup</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-client_name" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">client_name</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The name of the client (local) end of the socket, as reported by the
socket.</p>
          
          

          
          <div class="method-source-code" id="client_name-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 42</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">client_name</span>
  <span class="ruby-ivar">@client_name</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">sockaddr</span> = <span class="ruby-identifier">getsockname</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">sockaddr</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NAMEREQD</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">StandardError</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">sockaddr</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">StandardError</span>
        <span class="ruby-keyword">begin</span>
          <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">gethostbyname</span>(<span class="ruby-constant">Socket</span>.<span class="ruby-identifier">gethostname</span>).<span class="ruby-identifier">first</span>
        <span class="ruby-keyword">rescue</span> <span class="ruby-constant">StandardError</span>
          <span class="ruby-identifier">lwarn</span> { <span class="ruby-string">&quot;the client ipaddr/name could not be determined&quot;</span> }
          <span class="ruby-string">&quot;unknown&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-enqueue_packet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">enqueue_packet</span><span
            class="method-args">(payload)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Enqueues a packet to be sent, but does not immediately send the packet. The
given payload is pre-processed according to the algorithms specified in the
client state (compression, cipher, and hmac).</p>
          
          

          
          <div class="method-source-code" id="enqueue_packet-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 128</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">enqueue_packet</span>(<span class="ruby-identifier">payload</span>)
  <span class="ruby-comment"># try to compress the packet</span>
  <span class="ruby-identifier">payload</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">compress</span>(<span class="ruby-identifier">payload</span>)

  <span class="ruby-comment"># the length of the packet, minus the padding</span>
  <span class="ruby-identifier">actual_length</span> = (<span class="ruby-identifier">client</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">etm</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-value">4</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>

  <span class="ruby-comment"># compute the padding length</span>
  <span class="ruby-identifier">padding_length</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">-</span> (<span class="ruby-identifier">actual_length</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">block_size</span>)
  <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>

  <span class="ruby-comment"># compute the packet length (sans the length field itself)</span>
  <span class="ruby-identifier">packet_length</span> = <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">packet_length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">16</span>
    <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">block_size</span>
    <span class="ruby-identifier">packet_length</span> = <span class="ruby-identifier">payload</span>.<span class="ruby-identifier">bytesize</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">padding</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">padding_length</span>) { <span class="ruby-identifier">rand</span>(<span class="ruby-value">256</span>) }.<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;C*&quot;</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">etm</span>
    <span class="ruby-identifier">debug</span> { <span class="ruby-string">&quot;using encrypt-then-mac&quot;</span> }

    <span class="ruby-comment"># Encrypt padding_length, payload, and padding. Take MAC</span>
    <span class="ruby-comment"># from the unencrypted packet_lenght and the encrypted</span>
    <span class="ruby-comment"># data.</span>
    <span class="ruby-identifier">length_data</span> = [<span class="ruby-identifier">packet_length</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;N&quot;</span>)

    <span class="ruby-identifier">unencrypted_data</span> = [<span class="ruby-identifier">padding_length</span>, <span class="ruby-identifier">payload</span>, <span class="ruby-identifier">padding</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;CA*A*&quot;</span>)

    <span class="ruby-identifier">encrypted_data</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">unencrypted_data</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">final_cipher</span>

    <span class="ruby-identifier">mac_data</span> = <span class="ruby-identifier">length_data</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">encrypted_data</span>

    <span class="ruby-identifier">mac</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">digest</span>([<span class="ruby-identifier">client</span>.<span class="ruby-identifier">sequence_number</span>, <span class="ruby-identifier">mac_data</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;NA*&quot;</span>))

    <span class="ruby-identifier">message</span> = <span class="ruby-identifier">mac_data</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">mac</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">unencrypted_data</span> = [<span class="ruby-identifier">packet_length</span>, <span class="ruby-identifier">padding_length</span>, <span class="ruby-identifier">payload</span>, <span class="ruby-identifier">padding</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;NCA*A*&quot;</span>)

    <span class="ruby-identifier">mac</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">digest</span>([<span class="ruby-identifier">client</span>.<span class="ruby-identifier">sequence_number</span>, <span class="ruby-identifier">unencrypted_data</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;NA*&quot;</span>))

    <span class="ruby-identifier">encrypted_data</span> = <span class="ruby-identifier">client</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">unencrypted_data</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">final_cipher</span>

    <span class="ruby-identifier">message</span> = <span class="ruby-identifier">encrypted_data</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">mac</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;queueing packet nr #{client.sequence_number} type #{payload.getbyte(0)} len #{packet_length}&quot;</span> }
  <span class="ruby-identifier">enqueue</span>(<span class="ruby-identifier">message</span>)

  <span class="ruby-identifier">client</span>.<span class="ruby-identifier">increment</span>(<span class="ruby-identifier">packet_length</span>)

  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-if_needs_rekey-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">if_needs_rekey?</span><span
            class="method-args">() { || ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>If the IO object requires a rekey operation (as indicated by either its
client or server state objects, see <a
href="State.html#method-i-needs_rekey-3F">Net::SSH::Transport::State#needs_rekey?</a>),
this will yield. Otherwise, this does nothing.</p>
          
          

          
          <div class="method-source-code" id="if_needs_rekey-3F-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 194</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">if_needs_rekey?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">needs_rekey?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">needs_rekey?</span>
    <span class="ruby-keyword">yield</span>
    <span class="ruby-identifier">client</span>.<span class="ruby-identifier">reset!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">needs_rekey?</span>
    <span class="ruby-identifier">server</span>.<span class="ruby-identifier">reset!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">needs_rekey?</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-next_packet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">next_packet</span><span
            class="method-args">(mode=:nonblock, timeout=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns the next full packet. If the mode parameter is :nonblock (the
default), then this will return immediately, whether a packet is available
or not, and will return nil if there is no packet ready to be returned. If
the mode parameter is :block, then this method will block until a packet is
available or timeout seconds have passed.</p>
          
          

          
          <div class="method-source-code" id="next_packet-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 85</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">next_packet</span>(<span class="ruby-identifier">mode</span>=<span class="ruby-value">:nonblock</span>, <span class="ruby-identifier">timeout</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">mode</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:nonblock</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">packet</span> = <span class="ruby-identifier">poll_next_packet</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">packet</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">packet</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">available_for_read?</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">fill</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">result</span> = <span class="ruby-identifier">poll_next_packet</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">nil?</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Disconnect</span>, <span class="ruby-string">&quot;connection closed by remote host&quot;</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">poll_next_packet</span>

  <span class="ruby-keyword">when</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">packet</span> = <span class="ruby-identifier">poll_next_packet</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">packet</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">packet</span>

      <span class="ruby-identifier">result</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">select</span>([<span class="ruby-keyword">self</span>], <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">timeout</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionTimeout</span>, <span class="ruby-string">&quot;timeout waiting for next packet&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">result</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Disconnect</span>, <span class="ruby-string">&quot;connection closed by remote host&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">fill</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;expected :block or :nonblock, got #{mode.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-peer_ip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">peer_ip</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>The IP address of the peer (remote) end of the socket, as reported by the
socket.</p>
          
          

          
          <div class="method-source-code" id="peer_ip-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 64</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">peer_ip</span>
  <span class="ruby-ivar">@peer_ip</span> <span class="ruby-operator">||=</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:getpeername</span>)
      <span class="ruby-identifier">addr</span> = <span class="ruby-identifier">getpeername</span>
      <span class="ruby-constant">Socket</span>.<span class="ruby-identifier">getnameinfo</span>(<span class="ruby-identifier">addr</span>, <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NUMERICHOST</span> <span class="ruby-operator">|</span> <span class="ruby-constant">Socket</span><span class="ruby-operator">::</span><span class="ruby-constant">NI_NUMERICSERV</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">PROXY_COMMAND_HOST_IP</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-send_packet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">send_packet</span><span
            class="method-args">(payload)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Enqueues a packet to be sent, and blocks until the entire packet is sent.</p>
          
          

          
          <div class="method-source-code" id="send_packet-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 120</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">send_packet</span>(<span class="ruby-identifier">payload</span>)
  <span class="ruby-identifier">enqueue_packet</span>(<span class="ruby-identifier">payload</span>)
  <span class="ruby-identifier">wait_for_pending_sends</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="protected-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Protected Instance Methods</h3>
       </header>

    
      <div id="method-i-initialize_ssh" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">initialize_ssh</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Called when this module is used to extend an object. It initializes the
states and generally prepares the object for use as a packet stream.</p>
          
          

          
          <div class="method-source-code" id="initialize_ssh-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 206</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize_ssh</span>
  <span class="ruby-ivar">@hints</span>  = {}
  <span class="ruby-ivar">@server</span> = <span class="ruby-constant">State</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>, <span class="ruby-value">:server</span>)
  <span class="ruby-ivar">@client</span> = <span class="ruby-constant">State</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>, <span class="ruby-value">:client</span>)
  <span class="ruby-ivar">@packet</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">initialize_buffered_io</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-poll_next_packet" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">poll_next_packet</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Tries to read the next packet. If there is insufficient data to read an
entire packet, this returns immediately, otherwise the packet is read,
post-processed according to the cipher, hmac, and compression algorithms
specified in the server state object, and returned as a new <a
href="../Packet.html">Packet</a> object.</p>
          
          

          
          <div class="method-source-code" id="poll_next_packet-source">
            <pre><span class="ruby-comment"># File lib/net/ssh/transport/packet_stream.rb, line 219</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">poll_next_packet</span>
  <span class="ruby-identifier">aad_length</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">etm</span> <span class="ruby-operator">?</span> <span class="ruby-value">4</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">minimum</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span> <span class="ruby-operator">?</span> <span class="ruby-value">4</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">block_size</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">available</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">minimum</span>
    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">minimum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">aad_length</span>)

    <span class="ruby-comment"># decipher it</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">etm</span>
      <span class="ruby-ivar">@packet_length</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-string">&quot;N&quot;</span>).<span class="ruby-identifier">first</span>
      <span class="ruby-ivar">@mac_data</span> = <span class="ruby-identifier">data</span>
      <span class="ruby-ivar">@packet</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Buffer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">data</span>[<span class="ruby-identifier">aad_length</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]))
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@packet</span> = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Buffer</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">data</span>))
      <span class="ruby-ivar">@packet_length</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read_long</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">need</span> = <span class="ruby-ivar">@packet_length</span> <span class="ruby-operator">+</span> <span class="ruby-value">4</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">aad_length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">block_size</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-node">&quot;padding error, need #{need} block #{server.block_size}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">block_size</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">available</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">mac_length</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">need</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-comment"># read the remainder of the packet and decrypt it.</span>
    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">need</span>)
    <span class="ruby-ivar">@mac_data</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">data</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">etm</span>
    <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">append</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">update_cipher</span>(<span class="ruby-identifier">data</span>))
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># get the hmac from the tail of the packet (if one exists), and</span>
  <span class="ruby-comment"># then validate it.</span>
  <span class="ruby-identifier">real_hmac</span> = <span class="ruby-identifier">read_available</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">mac_length</span>) <span class="ruby-operator">||</span> <span class="ruby-string">&quot;&quot;</span>

  <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">append</span>(<span class="ruby-identifier">server</span>.<span class="ruby-identifier">final_cipher</span>)
  <span class="ruby-identifier">padding_length</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read_byte</span>

  <span class="ruby-identifier">payload</span> = <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">read</span>(<span class="ruby-ivar">@packet_length</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">padding_length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)

  <span class="ruby-identifier">my_computed_hmac</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">etm</span>
                       <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">digest</span>([<span class="ruby-identifier">server</span>.<span class="ruby-identifier">sequence_number</span>, <span class="ruby-ivar">@mac_data</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;NA*&quot;</span>))
                     <span class="ruby-keyword">else</span>
                       <span class="ruby-identifier">server</span>.<span class="ruby-identifier">hmac</span>.<span class="ruby-identifier">digest</span>([<span class="ruby-identifier">server</span>.<span class="ruby-identifier">sequence_number</span>, <span class="ruby-ivar">@packet</span>.<span class="ruby-identifier">content</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;NA*&quot;</span>))
                     <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">SSH</span><span class="ruby-operator">::</span><span class="ruby-constant">Exception</span>, <span class="ruby-string">&quot;corrupted hmac detected&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">real_hmac</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">my_computed_hmac</span>

  <span class="ruby-comment"># try to decompress the payload, in case compression is active</span>
  <span class="ruby-identifier">payload</span> = <span class="ruby-identifier">server</span>.<span class="ruby-identifier">decompress</span>(<span class="ruby-identifier">payload</span>)

  <span class="ruby-identifier">debug</span> { <span class="ruby-node">&quot;received packet nr #{server.sequence_number} type #{payload.getbyte(0)} len #{@packet_length}&quot;</span> }

  <span class="ruby-identifier">server</span>.<span class="ruby-identifier">increment</span>(<span class="ruby-ivar">@packet_length</span>)
  <span class="ruby-ivar">@packet</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-keyword">return</span> <span class="ruby-constant">Packet</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">payload</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.0.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

